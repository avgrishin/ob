select
  t.Reg3ID,
  TreatyName = tr.Name,
  FinInstName = f.Name,
  SecName = s.Name,
  Num = case when s.Class = 0 then -1 else 1 end*t.Num
from (
  select r.Reg3ID, r.ValueID, sum(t.Type*t.Value) Num from tODRests r join tODTurns t on t.RestID = r.ID and t.TDate >= cast(getdate() as date) group by r.Reg3ID, r.ValueID
) t
 left join tTreaty tr on tr.TreatyID = t.Reg3ID
 left join tFinInst f on f.FinInstID = tr.FinInstID
 left join tSecurity s on s.SecurityID = t.ValueID
order by FinInstName, TreatyName, SecName
